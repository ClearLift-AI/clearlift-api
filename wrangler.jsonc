{
  "compatibility_date": "2025-10-30",
  "compatibility_flags": ["nodejs_compat"],
  "main": "src/index.ts",
  "name": "clearlift-api",
  "upload_source_maps": true,
  "observability": {
    "enabled": true
  },

  "vars": {
    "CLOUDFLARE_ACCOUNT_ID": "133c285e1182ce57a619c802eaf56fb0",
    "R2_BUCKET_NAME": "clearlift-db",
    "R2_SQL_TABLE": "clearlift.event_data_v4_1",
    "USE_D1_ANALYTICS": "true"
  },

  // Secrets Store bindings - required for OAuth and encryption
  "secrets_store_secrets": [
    {
      "binding": "ENCRYPTION_KEY",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "ENCRYPTION_KEY"
    },
    {
      "binding": "R2_SQL_TOKEN",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "R2_ADMIN_TOKEN"
    },
    {
      "binding": "GOOGLE_CLIENT_ID",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "GOOGLE_CLIENT_ID"
    },
    {
      "binding": "GOOGLE_CLIENT_SECRET",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "GOOGLE_CLIENT_SECRET"
    },
    {
      "binding": "GOOGLE_ADS_DEVELOPER_TOKEN",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "GOOGLE_ADS_DEVELOPER_TOKEN"
    },
    {
      "binding": "FACEBOOK_APP_ID",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "FB_APP_ID"
    },
    {
      "binding": "FACEBOOK_APP_SECRET",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "FB_APP_SECRET"
    },
    {
      "binding": "SENDGRID_API_KEY",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "SENDGRID_API_KEY"
    },
    {
      "binding": "ANTHROPIC_API_KEY",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "ANTHROPIC_API_KEY"
    },
    {
      "binding": "GEMINI_API_KEY",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "GEMINI_API_KEY"
    },
    {
      "binding": "TIKTOK_APP_ID",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "TIKTOK_APP_ID"
    },
    {
      "binding": "TIKTOK_APP_SECRET",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "TIKTOK_APP_SECRET"
    },
    {
      "binding": "SHOPIFY_CLIENT_ID",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "SHOPIFY_CLIENT_ID"
    },
    {
      "binding": "SHOPIFY_CLIENT_SECRET",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "SHOPIFY_CLIENT_SECRET"
    },
    {
      "binding": "JOBBER_CLIENT_ID",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "JOBBER_CLIENT_ID"
    },
    {
      "binding": "JOBBER_CLIENT_SECRET",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "JOBBER_CLIENT_SECRET"
    }
  ],

  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "clearlift-db-prod",
      "database_id": "8e55bba7-4b54-4992-b5e5-050611499c18",
      "migrations_dir": "migrations"
    },
    {
      "binding": "AI_DB",
      "database_name": "clearlift-ai-prod",
      "database_id": "3fb300f4-4523-4a29-9efc-955d1684f392",
      "migrations_dir": "migrations-ai"
    },
    {
      "binding": "ANALYTICS_DB",
      "database_name": "clearlift-analytics-prod",
      "database_id": "a69beb57-92c9-489c-8f55-86205b613010",
      "migrations_dir": "migrations-analytics"
    },
    // Platform data shards (for campaign/metrics storage)
    {
      "binding": "SHARD_0",
      "database_name": "clearlift-shard-0",
      "database_id": "432022d1-ea6d-46bf-a8ff-c5cdf2fc76a0"
    },
    {
      "binding": "SHARD_1",
      "database_name": "clearlift-shard-1",
      "database_id": "9aaa370f-3181-4466-a417-c812dfb2a5d6"
    },
    {
      "binding": "SHARD_2",
      "database_name": "clearlift-shard-2",
      "database_id": "698de5dc-3096-4d5f-bb55-d751436848c8"
    },
    {
      "binding": "SHARD_3",
      "database_name": "clearlift-shard-3",
      "database_id": "ff763599-df7b-4041-b766-b574e7b3415b"
    }
  ],

  // KV namespace for caching hot data (org settings, user profiles)
  "kv_namespaces": [
    {
      "binding": "CACHE",
      "id": "5492358b37c14b7b935de58c8597e73f"
    }
  ],

  "queues": {
    "producers": [
      {
        "binding": "SYNC_QUEUE",
        "queue": "sync-jobs"
      }
    ]
  },

  // Analytics Engine for real-time analytics queries
  "analytics_engine_datasets": [
    {
      "binding": "ANALYTICS",
      "dataset": "clearlift_events"
    }
  ],

  "workflows": [
    {
      "name": "analysis-workflow",
      "binding": "ANALYSIS_WORKFLOW",
      "class_name": "AnalysisWorkflow"
    },
    {
      "name": "attribution-workflow",
      "binding": "ATTRIBUTION_WORKFLOW",
      "class_name": "AttributionWorkflow"
    }
  ],

  // Service binding to queue-consumer for triggering workflows
  "services": [
    {
      "binding": "CLEARLIFT_CRON",
      "service": "clearlift-queue-consumer"
    }
  ],

  // Cron triggers for scheduled tasks
  "triggers": {
    "crons": [
      "0 5 * * *",        // Daily aggregation at 5 AM UTC
      "*/15 * * * *"      // Stale job cleanup every 15 minutes
    ]
  },

  // ============================================================================
  // LOCAL DEVELOPMENT ENVIRONMENT
  // ============================================================================
  // Run with: npx wrangler dev --env local
  // Secrets come from .dev.vars (not Secrets Store)
  "env": {
    "local": {
      "vars": {
        "CLOUDFLARE_ACCOUNT_ID": "133c285e1182ce57a619c802eaf56fb0",
        "R2_BUCKET_NAME": "clearlift-db",
        "R2_SQL_TABLE": "clearlift.event_data_v4_1"
      },
      "d1_databases": [
        {
          "binding": "DB",
          "database_name": "clearlift-db-prod",
          "database_id": "8e55bba7-4b54-4992-b5e5-050611499c18",
          "migrations_dir": "migrations"
        },
        {
          "binding": "AI_DB",
          "database_name": "clearlift-ai-prod",
          "database_id": "3fb300f4-4523-4a29-9efc-955d1684f392",
          "migrations_dir": "migrations-ai"
        },
        // Platform data shards
        {
          "binding": "SHARD_0",
          "database_name": "clearlift-shard-0",
          "database_id": "432022d1-ea6d-46bf-a8ff-c5cdf2fc76a0"
        },
        {
          "binding": "SHARD_1",
          "database_name": "clearlift-shard-1",
          "database_id": "9aaa370f-3181-4466-a417-c812dfb2a5d6"
        },
        {
          "binding": "SHARD_2",
          "database_name": "clearlift-shard-2",
          "database_id": "698de5dc-3096-4d5f-bb55-d751436848c8"
        },
        {
          "binding": "SHARD_3",
          "database_name": "clearlift-shard-3",
          "database_id": "ff763599-df7b-4041-b766-b574e7b3415b"
        }
      ],
      "queues": {
        "producers": [
          {
            "binding": "SYNC_QUEUE",
            "queue": "sync-jobs"
          }
        ]
      },
      "workflows": [
        {
          "name": "analysis-workflow",
          "binding": "ANALYSIS_WORKFLOW",
          "class_name": "AnalysisWorkflow"
        },
        {
          "name": "attribution-workflow-local",
          "binding": "ATTRIBUTION_WORKFLOW",
          "class_name": "AttributionWorkflow"
        }
      ]
      // No secrets_store_secrets - uses .dev.vars instead
    },

    // ========================================================================
    // PRODUCTION ENVIRONMENT
    // ========================================================================
    // Deploy with: npx wrangler deploy (default) or npx wrangler deploy --env production
    "production": {
      "vars": {
        "CLOUDFLARE_ACCOUNT_ID": "133c285e1182ce57a619c802eaf56fb0",
        "R2_BUCKET_NAME": "clearlift-db",
        "R2_SQL_TABLE": "clearlift.event_data_v4_1",
        "USE_D1_ANALYTICS": "true"
      },
      "d1_databases": [
        {
          "binding": "DB",
          "database_name": "clearlift-db-prod",
          "database_id": "8e55bba7-4b54-4992-b5e5-050611499c18",
          "migrations_dir": "migrations"
        },
        {
          "binding": "AI_DB",
          "database_name": "clearlift-ai-prod",
          "database_id": "3fb300f4-4523-4a29-9efc-955d1684f392",
          "migrations_dir": "migrations-ai"
        },
        {
          "binding": "ANALYTICS_DB",
          "database_name": "clearlift-analytics-dev",
          "database_id": "57a7e42f-3a52-4b15-b237-bc1338e5fb61"
        }
      ],
      "queues": {
        "producers": [
          {
            "binding": "SYNC_QUEUE",
            "queue": "sync-jobs"
          }
        ]
      },
      "workflows": [
        {
          "name": "analysis-workflow",
          "binding": "ANALYSIS_WORKFLOW",
          "class_name": "AnalysisWorkflow"
        },
        {
          "name": "attribution-workflow",
          "binding": "ATTRIBUTION_WORKFLOW",
          "class_name": "AttributionWorkflow"
        }
      ],
      "secrets_store_secrets": [
        {
          "binding": "ENCRYPTION_KEY",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "ENCRYPTION_KEY"
        },
        {
          "binding": "R2_SQL_TOKEN",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "R2_ADMIN_TOKEN"
        },
        {
          "binding": "GOOGLE_CLIENT_ID",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "GOOGLE_CLIENT_ID"
        },
        {
          "binding": "GOOGLE_CLIENT_SECRET",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "GOOGLE_CLIENT_SECRET"
        },
        {
          "binding": "GOOGLE_ADS_DEVELOPER_TOKEN",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "GOOGLE_ADS_DEVELOPER_TOKEN"
        },
        {
          "binding": "FACEBOOK_APP_ID",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "FB_APP_ID"
        },
        {
          "binding": "FACEBOOK_APP_SECRET",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "FB_APP_SECRET"
        },
        {
          "binding": "SENDGRID_API_KEY",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "SENDGRID_API_KEY"
        },
        {
          "binding": "ANTHROPIC_API_KEY",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "ANTHROPIC_API_KEY"
        },
        {
          "binding": "GEMINI_API_KEY",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "GEMINI_API_KEY"
        },
        {
          "binding": "TIKTOK_APP_ID",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "TIKTOK_APP_ID"
        },
        {
          "binding": "TIKTOK_APP_SECRET",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "TIKTOK_APP_SECRET"
        },
        {
          "binding": "SHOPIFY_CLIENT_ID",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "SHOPIFY_CLIENT_ID"
        },
        {
          "binding": "SHOPIFY_CLIENT_SECRET",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "SHOPIFY_CLIENT_SECRET"
        },
        {
          "binding": "JOBBER_CLIENT_ID",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "JOBBER_CLIENT_ID"
        },
        {
          "binding": "JOBBER_CLIENT_SECRET",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "JOBBER_CLIENT_SECRET"
        }
      ]
    },

    // ========================================================================
    // DEV ENVIRONMENT
    // ========================================================================
    // Deploy with: npx wrangler deploy --env dev
    // Accessible at: dev.clearlift.ai (via api-dev.clearlift.ai)
    // Uses D1 ANALYTICS_DB for events/touchpoints/metrics
    "dev": {
      "name": "clearlift-api-dev",
      "vars": {
        "CLOUDFLARE_ACCOUNT_ID": "133c285e1182ce57a619c802eaf56fb0",
        "R2_BUCKET_NAME": "clearlift-db",
        "R2_SQL_TABLE": "clearlift.event_data_v4_1",
        "USE_D1_ANALYTICS": "true"
      },
      "d1_databases": [
        {
          "binding": "DB",
          "database_name": "clearlift-db-prod",
          "database_id": "8e55bba7-4b54-4992-b5e5-050611499c18",
          "migrations_dir": "migrations"
        },
        {
          "binding": "AI_DB",
          "database_name": "clearlift-ai-prod",
          "database_id": "3fb300f4-4523-4a29-9efc-955d1684f392",
          "migrations_dir": "migrations-ai"
        },
        {
          "binding": "ANALYTICS_DB",
          "database_name": "clearlift-analytics-dev",
          "database_id": "57a7e42f-3a52-4b15-b237-bc1338e5fb61",
          "migrations_dir": "migrations-analytics"
        }
      ],
      "queues": {
        "producers": [
          {
            "binding": "SYNC_QUEUE",
            "queue": "sync-jobs-dev"
          }
        ]
      },
      "workflows": [
        {
          "name": "analysis-workflow-dev",
          "binding": "ANALYSIS_WORKFLOW",
          "class_name": "AnalysisWorkflow"
        },
        {
          "name": "attribution-workflow-dev",
          "binding": "ATTRIBUTION_WORKFLOW",
          "class_name": "AttributionWorkflow"
        }
      ],
      "services": [
        {
          "binding": "CLEARLIFT_CRON",
          "service": "clearlift-queue-consumer-dev"
        }
      ],
      "secrets_store_secrets": [
        {
          "binding": "ENCRYPTION_KEY",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "ENCRYPTION_KEY"
        },
        {
          "binding": "R2_SQL_TOKEN",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "R2_ADMIN_TOKEN"
        },
        {
          "binding": "GOOGLE_CLIENT_ID",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "GOOGLE_CLIENT_ID"
        },
        {
          "binding": "GOOGLE_CLIENT_SECRET",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "GOOGLE_CLIENT_SECRET"
        },
        {
          "binding": "GOOGLE_ADS_DEVELOPER_TOKEN",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "GOOGLE_ADS_DEVELOPER_TOKEN"
        },
        {
          "binding": "FACEBOOK_APP_ID",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "FB_APP_ID"
        },
        {
          "binding": "FACEBOOK_APP_SECRET",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "FB_APP_SECRET"
        },
        {
          "binding": "SENDGRID_API_KEY",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "SENDGRID_API_KEY"
        },
        {
          "binding": "ANTHROPIC_API_KEY",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "ANTHROPIC_API_KEY"
        },
        {
          "binding": "GEMINI_API_KEY",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "GEMINI_API_KEY"
        },
        {
          "binding": "TIKTOK_APP_ID",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "TIKTOK_APP_ID"
        },
        {
          "binding": "TIKTOK_APP_SECRET",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "TIKTOK_APP_SECRET"
        },
        {
          "binding": "SHOPIFY_CLIENT_ID",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "SHOPIFY_CLIENT_ID"
        },
        {
          "binding": "SHOPIFY_CLIENT_SECRET",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "SHOPIFY_CLIENT_SECRET"
        },
        {
          "binding": "JOBBER_CLIENT_ID",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "JOBBER_CLIENT_ID"
        },
        {
          "binding": "JOBBER_CLIENT_SECRET",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "JOBBER_CLIENT_SECRET"
        }
      ]
    }
  }
}