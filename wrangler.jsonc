{
  "compatibility_date": "2025-12-30",
  "compatibility_flags": ["nodejs_compat"],
  "main": "src/index.ts",
  "name": "clearlift-api",
  "upload_source_maps": true,
  "observability": {
    "enabled": true
  },

  // Production routes for adbliss.io
  "routes": [{ "pattern": "api.adbliss.io/*", "zone_name": "adbliss.io" }],

  "vars": {
    "CLOUDFLARE_ACCOUNT_ID": "133c285e1182ce57a619c802eaf56fb0",
    "R2_BUCKET_NAME": "clearlift-db",
    "R2_SQL_TABLE": "clearlift.event_data_v4_1",
    "USE_D1_ANALYTICS": "true",
    "OAUTH_CALLBACK_BASE": "https://api.adbliss.io",
    "APP_BASE_URL": "https://app.adbliss.io",
    "CDN_BASE_URL": "https://cdn.adbliss.io",
    "IRIS_BASE_URL": "https://iris.adbliss.io"
  },

  // Secrets Store bindings - required for OAuth and encryption
  "secrets_store_secrets": [
    {
      "binding": "ENCRYPTION_KEY",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "ENCRYPTION_KEY"
    },
    {
      "binding": "R2_SQL_TOKEN",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "R2_ADMIN_TOKEN"
    },
    {
      "binding": "GOOGLE_CLIENT_ID",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "GOOGLE_CLIENT_ID"
    },
    {
      "binding": "GOOGLE_CLIENT_SECRET",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "GOOGLE_CLIENT_SECRET"
    },
    {
      "binding": "GOOGLE_ADS_DEVELOPER_TOKEN",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "GOOGLE_ADS_DEVELOPER_TOKEN"
    },
    {
      "binding": "FACEBOOK_APP_ID",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "FB_APP_ID"
    },
    {
      "binding": "FACEBOOK_APP_SECRET",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "FB_APP_SECRET"
    },
    {
      "binding": "SENDGRID_API_KEY",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "SENDGRID_API_KEY"
    },
    {
      "binding": "ANTHROPIC_API_KEY",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "ANTHROPIC_API_KEY"
    },
    {
      "binding": "GEMINI_API_KEY",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "GEMINI_API_KEY"
    },
    {
      "binding": "TIKTOK_APP_ID",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "TIKTOK_APP_ID"
    },
    {
      "binding": "TIKTOK_APP_SECRET",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "TIKTOK_APP_SECRET"
    },
    {
      "binding": "SHOPIFY_CLIENT_ID",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "SHOPIFY_CLIENT_ID"
    },
    {
      "binding": "SHOPIFY_CLIENT_SECRET",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "SHOPIFY_CLIENT_SECRET"
    },
    {
      "binding": "JOBBER_CLIENT_ID",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "JOBBER_CLIENT_ID"
    },
    {
      "binding": "JOBBER_CLIENT_SECRET",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "JOBBER_CLIENT_SECRET"
    },
    {
      "binding": "HUBSPOT_CLIENT_ID",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "HUBSPOT_CLIENT_ID"
    },
    {
      "binding": "HUBSPOT_CLIENT_SECRET",
      "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
      "secret_name": "HUBSPOT_CLIENT_SECRET"
    }
    // SALESFORCE_CLIENT_ID and SALESFORCE_CLIENT_SECRET removed - connector not implemented yet
  ],

  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "clearlift-db-prod",
      "database_id": "8e55bba7-4b54-4992-b5e5-050611499c18",
      "migrations_dir": "migrations"
    },
    {
      "binding": "AI_DB",
      "database_name": "clearlift-ai-prod",
      "database_id": "3fb300f4-4523-4a29-9efc-955d1684f392",
      "migrations_dir": "migrations-ai"
    },
    {
      "binding": "ANALYTICS_DB",
      "database_name": "clearlift-analytics-prod",
      "database_id": "a69beb57-92c9-489c-8f55-86205b613010",
      "migrations_dir": "migrations-analytics"
    },
    // Platform data shards (for campaign/metrics storage + pre-aggregation)
    {
      "binding": "SHARD_0",
      "database_name": "clearlift-shard-0",
      "database_id": "432022d1-ea6d-46bf-a8ff-c5cdf2fc76a0",
      "migrations_dir": "shard-migrations"
    },
    {
      "binding": "SHARD_1",
      "database_name": "clearlift-shard-1",
      "database_id": "9aaa370f-3181-4466-a417-c812dfb2a5d6",
      "migrations_dir": "shard-migrations"
    },
    {
      "binding": "SHARD_2",
      "database_name": "clearlift-shard-2",
      "database_id": "698de5dc-3096-4d5f-bb55-d751436848c8",
      "migrations_dir": "shard-migrations"
    },
    {
      "binding": "SHARD_3",
      "database_name": "clearlift-shard-3",
      "database_id": "ff763599-df7b-4041-b766-b574e7b3415b",
      "migrations_dir": "shard-migrations"
    },
  ],

  // KV namespace for caching hot data (org settings, user profiles)
  "kv_namespaces": [
    {
      "binding": "CACHE",
      "id": "5492358b37c14b7b935de58c8597e73f"
    }
  ],

  "queues": {
    "producers": [
      {
        "binding": "SYNC_QUEUE",
        "queue": "sync-jobs"
      }
    ]
  },

  // Analytics Engine for real-time analytics queries
  "analytics_engine_datasets": [
    {
      "binding": "ANALYTICS",
      "dataset": "clearlift_events"
    }
  ],

  "workflows": [
    {
      "name": "analysis-workflow",
      "binding": "ANALYSIS_WORKFLOW",
      "class_name": "AnalysisWorkflow"
    }
  ],

  // Service binding to queue-consumer for triggering workflows
  "services": [
    {
      "binding": "CLEARLIFT_CRON",
      "service": "clearlift-queue-consumer"
    }
  ],

  // Cron triggers — only stale job cleanup remains (aggregation + periodic sync moved to clearlift-cron)
  "triggers": {
    "crons": [
      "*/15 * * * *"      // Stale job cleanup every 15 minutes
    ]
  },

  // ============================================================================
  // LOCAL DEVELOPMENT ENVIRONMENT
  // ============================================================================
  // Run with: npx wrangler dev --env local
  // Secrets come from .dev.vars (not Secrets Store)
  "env": {
    "local": {
      "vars": {
        "CLOUDFLARE_ACCOUNT_ID": "133c285e1182ce57a619c802eaf56fb0",
        "R2_BUCKET_NAME": "clearlift-db",
        "R2_SQL_TABLE": "clearlift.event_data_v4_1",
        "USE_D1_ANALYTICS": "true"
      },
      "d1_databases": [
        {
          "binding": "DB",
          "database_name": "adbliss-core",
          "database_id": "00000000-0000-0000-0000-000000000001",
          "migrations_dir": "migrations-adbliss-core"
        },
        {
          "binding": "ANALYTICS_DB",
          "database_name": "adbliss-analytics-0",
          "database_id": "00000000-0000-0000-0000-000000000002",
          "migrations_dir": "migrations-adbliss-analytics"
        }
        // AI_DB: REMOVED (merged into DB)
        // SHARD_0-3: REMOVED (shard system dormant, all queries use ANALYTICS_DB)
      ],
      "queues": {
        "producers": [
          {
            "binding": "SYNC_QUEUE",
            "queue": "sync-jobs"
          }
        ]
      },
      "workflows": [
        {
          "name": "analysis-workflow",
          "binding": "ANALYSIS_WORKFLOW",
          "class_name": "AnalysisWorkflow"
        }
      ],
      // KV namespace for local caching (emulated by wrangler)
      "kv_namespaces": [
        {
          "binding": "CACHE",
          "id": "5492358b37c14b7b935de58c8597e73f"
        }
      ]
      // No secrets_store_secrets - uses .dev.vars instead
    },

    // ========================================================================
    // PRODUCTION ENVIRONMENT
    // ========================================================================
    // Deploy with: npx wrangler deploy (default) or npx wrangler deploy --env production
    "production": {
      "vars": {
        "CLOUDFLARE_ACCOUNT_ID": "133c285e1182ce57a619c802eaf56fb0",
        "R2_BUCKET_NAME": "clearlift-db",
        "R2_SQL_TABLE": "clearlift.event_data_v4_1",
        "USE_D1_ANALYTICS": "true"
      },
      "kv_namespaces": [
        {
          "binding": "CACHE",
          "id": "5492358b37c14b7b935de58c8597e73f"
        }
      ],
      "d1_databases": [
        {
          "binding": "DB",
          "database_name": "clearlift-db-prod",
          "database_id": "8e55bba7-4b54-4992-b5e5-050611499c18",
          "migrations_dir": "migrations"
        },
        {
          "binding": "AI_DB",
          "database_name": "clearlift-ai-prod",
          "database_id": "3fb300f4-4523-4a29-9efc-955d1684f392",
          "migrations_dir": "migrations-ai"
        },
        {
          "binding": "ANALYTICS_DB",
          "database_name": "clearlift-analytics-prod",
          "database_id": "a69beb57-92c9-489c-8f55-86205b613010",
          "migrations_dir": "migrations-analytics"
        },
        // Platform data shards (for campaign/metrics storage + pre-aggregation)
        {
          "binding": "SHARD_0",
          "database_name": "clearlift-shard-0",
          "database_id": "432022d1-ea6d-46bf-a8ff-c5cdf2fc76a0",
          "migrations_dir": "shard-migrations"
        },
        {
          "binding": "SHARD_1",
          "database_name": "clearlift-shard-1",
          "database_id": "9aaa370f-3181-4466-a417-c812dfb2a5d6",
          "migrations_dir": "shard-migrations"
        },
        {
          "binding": "SHARD_2",
          "database_name": "clearlift-shard-2",
          "database_id": "698de5dc-3096-4d5f-bb55-d751436848c8",
          "migrations_dir": "shard-migrations"
        },
        {
          "binding": "SHARD_3",
          "database_name": "clearlift-shard-3",
          "database_id": "ff763599-df7b-4041-b766-b574e7b3415b",
          "migrations_dir": "shard-migrations"
        }
      ],
      "queues": {
        "producers": [
          {
            "binding": "SYNC_QUEUE",
            "queue": "sync-jobs"
          }
        ]
      },
      "workflows": [
        {
          "name": "analysis-workflow",
          "binding": "ANALYSIS_WORKFLOW",
          "class_name": "AnalysisWorkflow"
        }
      ],
      "secrets_store_secrets": [
        {
          "binding": "ENCRYPTION_KEY",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "ENCRYPTION_KEY"
        },
        {
          "binding": "R2_SQL_TOKEN",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "R2_ADMIN_TOKEN"
        },
        {
          "binding": "GOOGLE_CLIENT_ID",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "GOOGLE_CLIENT_ID"
        },
        {
          "binding": "GOOGLE_CLIENT_SECRET",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "GOOGLE_CLIENT_SECRET"
        },
        {
          "binding": "GOOGLE_ADS_DEVELOPER_TOKEN",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "GOOGLE_ADS_DEVELOPER_TOKEN"
        },
        {
          "binding": "FACEBOOK_APP_ID",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "FB_APP_ID"
        },
        {
          "binding": "FACEBOOK_APP_SECRET",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "FB_APP_SECRET"
        },
        {
          "binding": "SENDGRID_API_KEY",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "SENDGRID_API_KEY"
        },
        {
          "binding": "ANTHROPIC_API_KEY",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "ANTHROPIC_API_KEY"
        },
        {
          "binding": "GEMINI_API_KEY",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "GEMINI_API_KEY"
        },
        {
          "binding": "TIKTOK_APP_ID",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "TIKTOK_APP_ID"
        },
        {
          "binding": "TIKTOK_APP_SECRET",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "TIKTOK_APP_SECRET"
        },
        {
          "binding": "SHOPIFY_CLIENT_ID",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "SHOPIFY_CLIENT_ID"
        },
        {
          "binding": "SHOPIFY_CLIENT_SECRET",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "SHOPIFY_CLIENT_SECRET"
        },
        {
          "binding": "JOBBER_CLIENT_ID",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "JOBBER_CLIENT_ID"
        },
        {
          "binding": "JOBBER_CLIENT_SECRET",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "JOBBER_CLIENT_SECRET"
        },
        {
          "binding": "HUBSPOT_CLIENT_ID",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "HUBSPOT_CLIENT_ID"
        },
        {
          "binding": "HUBSPOT_CLIENT_SECRET",
          "store_id": "b97bbcc69dce4f59b1043024f8a68f19",
          "secret_name": "HUBSPOT_CLIENT_SECRET"
        }
        // SALESFORCE secrets removed - connector not implemented yet
      ]
    },

    // ========================================================================
    // STAGING ENVIRONMENT — Fully Isolated from Production
    // ========================================================================
    // Deploy with: npx wrangler deploy --env staging
    // Accessible at: api-dev.clearlift.ai
    // Every D1/R2/KV/AE resource has a unique staging ID — zero cross-wire risk
    "staging": {
      "name": "clearlift-api-staging",
      "routes": [{ "pattern": "api-dev.clearlift.ai/*", "zone_name": "clearlift.ai" }],
      "vars": {
        "CLOUDFLARE_ACCOUNT_ID": "133c285e1182ce57a619c802eaf56fb0",
        "R2_BUCKET_NAME": "clearlift-db-staging",
        "R2_SQL_TABLE": "clearlift.event_data_v5_staging",
        "USE_D1_ANALYTICS": "true",
        "OAUTH_CALLBACK_BASE": "https://api-dev.clearlift.ai",
        "APP_BASE_URL": "https://dev.clearlift.ai",
        "CDN_BASE_URL": "https://cdn.clearlift.ai",
        "IRIS_BASE_URL": "https://iris-dev.clearlift.ai",
        "EMAIL_DRY_RUN": "true"
      },
      "d1_databases": [
        { "binding": "DB",           "database_name": "adbliss-core-staging",      "database_id": "9b76b070-c22c-4cfe-a74b-0e7ff796a821", "migrations_dir": "migrations-adbliss-core" },
        { "binding": "ANALYTICS_DB", "database_name": "adbliss-analytics-staging", "database_id": "76448094-1790-4347-9bef-f63fb8ad55ee", "migrations_dir": "migrations-adbliss-analytics" }
      ],
      "kv_namespaces": [{ "binding": "CACHE", "id": "4ac9423601984ea1a03f382eba42af93" }],
      "queues": { "producers": [{ "binding": "SYNC_QUEUE", "queue": "sync-jobs-staging" }] },
      "analytics_engine_datasets": [{ "binding": "ANALYTICS", "dataset": "clearlift_events_staging" }],
      "workflows": [
        { "name": "analysis-workflow-staging",    "binding": "ANALYSIS_WORKFLOW",    "class_name": "AnalysisWorkflow" }
      ],
      "services": [{ "binding": "CLEARLIFT_CRON", "service": "clearlift-queue-consumer-staging" }],
      "triggers": { "crons": [] },
      // NOTE: ENCRYPTION_KEY uses production secret (not ENCRYPTION_KEY_STAGING) because staging
      // receives OAuth tokens copied from production during D1 migration. These tokens were
      // encrypted with the production key and must be decrypted with the same key.
      // After migration is validated, consider reverting to ENCRYPTION_KEY_STAGING.
      "secrets_store_secrets": [
        { "binding": "ENCRYPTION_KEY",            "store_id": "b97bbcc69dce4f59b1043024f8a68f19", "secret_name": "ENCRYPTION_KEY" },
        { "binding": "R2_SQL_TOKEN",              "store_id": "b97bbcc69dce4f59b1043024f8a68f19", "secret_name": "R2_ADMIN_TOKEN" },
        { "binding": "GOOGLE_CLIENT_ID",          "store_id": "b97bbcc69dce4f59b1043024f8a68f19", "secret_name": "GOOGLE_CLIENT_ID" },
        { "binding": "GOOGLE_CLIENT_SECRET",      "store_id": "b97bbcc69dce4f59b1043024f8a68f19", "secret_name": "GOOGLE_CLIENT_SECRET" },
        { "binding": "GOOGLE_ADS_DEVELOPER_TOKEN","store_id": "b97bbcc69dce4f59b1043024f8a68f19", "secret_name": "GOOGLE_ADS_DEVELOPER_TOKEN" },
        { "binding": "FACEBOOK_APP_ID",           "store_id": "b97bbcc69dce4f59b1043024f8a68f19", "secret_name": "FB_APP_ID" },
        { "binding": "FACEBOOK_APP_SECRET",       "store_id": "b97bbcc69dce4f59b1043024f8a68f19", "secret_name": "FB_APP_SECRET" },
        { "binding": "SENDGRID_API_KEY",          "store_id": "b97bbcc69dce4f59b1043024f8a68f19", "secret_name": "SENDGRID_API_KEY" },
        { "binding": "ANTHROPIC_API_KEY",         "store_id": "b97bbcc69dce4f59b1043024f8a68f19", "secret_name": "ANTHROPIC_API_KEY" },
        { "binding": "GEMINI_API_KEY",            "store_id": "b97bbcc69dce4f59b1043024f8a68f19", "secret_name": "GEMINI_API_KEY" },
        { "binding": "TIKTOK_APP_ID",             "store_id": "b97bbcc69dce4f59b1043024f8a68f19", "secret_name": "TIKTOK_APP_ID" },
        { "binding": "TIKTOK_APP_SECRET",         "store_id": "b97bbcc69dce4f59b1043024f8a68f19", "secret_name": "TIKTOK_APP_SECRET" },
        { "binding": "SHOPIFY_CLIENT_ID",         "store_id": "b97bbcc69dce4f59b1043024f8a68f19", "secret_name": "SHOPIFY_CLIENT_ID" },
        { "binding": "SHOPIFY_CLIENT_SECRET",     "store_id": "b97bbcc69dce4f59b1043024f8a68f19", "secret_name": "SHOPIFY_CLIENT_SECRET" },
        { "binding": "JOBBER_CLIENT_ID",          "store_id": "b97bbcc69dce4f59b1043024f8a68f19", "secret_name": "JOBBER_CLIENT_ID" },
        { "binding": "JOBBER_CLIENT_SECRET",      "store_id": "b97bbcc69dce4f59b1043024f8a68f19", "secret_name": "JOBBER_CLIENT_SECRET" },
        { "binding": "HUBSPOT_CLIENT_ID",         "store_id": "b97bbcc69dce4f59b1043024f8a68f19", "secret_name": "HUBSPOT_CLIENT_ID" },
        { "binding": "HUBSPOT_CLIENT_SECRET",     "store_id": "b97bbcc69dce4f59b1043024f8a68f19", "secret_name": "HUBSPOT_CLIENT_SECRET" }
      ]
    }
  }
}